name: '1 - [feat] Build & Pull Request'

on:
  push:
    branches:
      - 'feature/**'

jobs:
  validar:
    runs-on: ubuntu-latest
    steps:
      - name: Checar o nome da branch
        run: |
          if [[ ! ${{ github.ref }} =~ ^refs/heads/feature/ ]]; then
            echo "O nome da branch não começa com 'feature/'. Use um nome de branch válido."
            exit 1
          fi

      - name: Checar repositório
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.0.0

      - name: Valida sintaxe do terraform
        run: terraform validate

  pull_request:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Solicitar revisão
        run: |
          echo "This pull request needs a review to be merged." > review.md
          gh pr review --body "$(cat review.md)" --approve

      - name: Merge com a main
        if: github.event_name == 'pull_request_review' && github.event.action == 'submitted' && github.event.review.state == 'approved'
        run: |
          gh pr merge --auto --merge --delete-branch